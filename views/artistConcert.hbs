<div class="container">
    <!-- Section: Display List of Artists Performing at a Concert -->
    <h2>List of Artists performing at a Concert</h2>
    <table>
        <thead>
            <tr>
                <!-- Dynamically generate table headers based on the first row of data -->
                {{#each data.[0]}}
                <th>{{@key}}</th>
                {{/each}}
                <!-- Extra headers for action buttons -->
                <th colspan="2">Actions</th>
            </tr>
        </thead>
        <tbody>
            <!-- Iterate over each data row to create table rows -->
            {{#each data}}
                <tr data-id="{{this.artistConcertID}}" data-artist-id="{{this.artistID}}" data-concert-id="{{this.concertID}}">
                    <td>{{ this.artistConcertID }}</td>
                    <td>{{ this.artistID }}</td>
                    <td>{{ this.concertID }}</td>
                    <!-- Action buttons for editing and deleting rows -->
                    <td><a href="#" class="edit-btn">Edit</a></td>
                    <td><a href="#" class="delete-btn">Delete</a></td>
                </tr>
            {{/each}}
        </tbody>
    </table>

    <!-- Section: Form to Add an Artist to a Concert -->
    <h3>Add an Artist Performing at a Concert</h3>
    <p>To add a new artist performing at a concert, please select the artist and concert, then click 'Add Artist Performing at a Concert'!</p>
    <form id="add-artist-to-concert-form" action="/add-artist-to-concert-form" method="POST">
        <!-- Dropdown to select artist -->
        <label for="artistName">Artist ID: </label>
        <select name="artistID" id="artistName">
            <option value="">Select an Artist:</option>
            {{#each artist}}
                <option value="{{this.artistID}}">{{this.artistName}}</option>
            {{/each}}
        </select><br>

        <!-- Dropdown to select concert -->
        <label for="concertLocation">Concert ID: </label>
        <select name="concertID" id="concertLocation">
            <option value="">Select a Concert:</option>
            {{#each concert}}
                <option value="{{this.concertID}}">{{this.location}}</option>
            {{/each}}
        </select><br>

        <!-- Submit button -->
        <input type="submit" value="Add Artist Performing at a Concert">
    </form>

    <!-- Popup Form for Updating Artist at Concert -->
    <div id="popupMenu" class="popup">
        <div class="popup-content">
            <form id="update-artist-to-concert-form" action="/update-artist-to-concert" method="POST">
                <!-- Hidden input to store the ID of the row being updated -->
                <input type="hidden" name="artistConcertID" id="popupArtistConcertID">

                <!-- Dropdown to update artist -->
                <label for="popupArtistName">Artist ID:</label>
                <select name="artistID" id="popupArtistName">
                    <option value="">Select an Artist:</option>
                    {{#each artist}}
                        <option value="{{this.artistID}}">{{this.artistName}}</option>
                    {{/each}}
                </select><br>

                <!-- Dropdown to update concert -->
                <label for="popupConcertLocation">Concert ID:</label>
                <select name="concertID" id="popupConcertLocation">
                    <option value="">Select a Concert:</option>
                    {{#each concert}}
                        <option value="{{this.concertID}}">{{this.location}}</option>
                    {{/each}}
                </select><br>

                <!-- Submit button for the update form -->
                <input type="submit" value="Update Artist Performing at a Concert">
            </form>
            <!-- Close button for the popup -->
            <span id="closePopup" class="close">&times;</span>
            <button id="closeButton">Close</button>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // Select elements needed for interaction
    const deleteButtons = document.querySelectorAll(".delete-btn");
    const editButtons = document.querySelectorAll(".edit-btn");
    const popupMenu = document.getElementById("popupMenu");
    const closePopup = document.getElementById("closePopup");
    const closeButton = document.getElementById("closeButton");
    const updateForm = document.getElementById("update-artist-to-concert-form");
    const popupArtistName = document.getElementById("popupArtistName");
    const popupConcertLocation = document.getElementById("popupConcertLocation");
    const popupArtistConcertID = document.getElementById("popupArtistConcertID");

    // Handle Delete Button Click
    deleteButtons.forEach(button => {
        button.addEventListener("click", async function (event) {
            event.preventDefault();

            // Get the row being deleted and its unique ID
            const row = button.closest("tr");
            const artistConcertID = row.getAttribute("data-id");
            row.remove();

            try {
                const response = await fetch(`/delete-artist-concert/${artistConcertID}`, {
                    method: 'DELETE',
                });
                if (!response.ok) {
                    throw new Error('Delete request failed');
                }
            } catch (error) {
                console.error("Error:", error);
            }
        });
    });

    // Handle Edit Button Click
    editButtons.forEach(button => {
        button.addEventListener("click", (event) => {
            event.preventDefault();

            // Get the row being edited and its attributes
            const row = button.closest("tr");
            const artistConcertID = row.getAttribute("data-id");
            const artistID = row.getAttribute("data-artist-id");
            const concertID = row.getAttribute("data-concert-id");

            // Populate popup form fields with current data
            updateForm.setAttribute("action", `/update-artist-to-concert/${artistConcertID}`);
            popupArtistConcertID.value = artistConcertID;
            popupArtistName.value = artistID;
            popupConcertLocation.value = concertID;

            popupMenu.style.display = "flex";
        });
    });

    // Handle Closing the Popup
    closePopup.addEventListener("click", () => {
        popupMenu.style.display = "none";
    });
    closeButton.addEventListener("click", () => {
        popupMenu.style.display = "none";
    });

    // Close Popup when Clicking Outside
    window.addEventListener("click", (event) => {
        if (event.target === popupMenu) {
            popupMenu.style.display = "none";
        }
    });

    // Handle Update Form Submission
    updateForm.addEventListener("submit", async (event) => {
        event.preventDefault();

        const formData = new FormData(updateForm);
        const artistConcertID = updateForm.getAttribute("action").split("/").pop();

        const payload = {
            concertID: formData.get("concertID"),
            artistID: formData.get("artistID"),
        };

        try {
            const response = await fetch(`/update-artist-to-concert/${artistConcertID}`, {
                method: 'POST',
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(payload),
            });

            if (response.ok) {
                // Update table row with the new values
                const row = document.querySelector(`tr[data-id="${artistConcertID}"]`);
                row.setAttribute("data-artist-id", popupArtistName.value);
                row.setAttribute("data-concert-id", popupConcertLocation.value);
                row.children[1].textContent = popupArtistName.value;
                row.children[2].textContent = popupConcertLocation.value;

                popupMenu.style.display = "none";
            } else {
                console.error("Update failed:", response.statusText);
            }
        } catch (error) {
            console.error("Error:", error);
        }
    });
});
</script>
